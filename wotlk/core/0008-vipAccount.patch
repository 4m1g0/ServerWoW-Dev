From e08f803b32cf4dff74155e0338d05eb268c0aa78 Mon Sep 17 00:00:00 2001
From: 4m1g0 <casadelblanco@gmail.com>
Date: Sun, 19 Feb 2012 23:22:28 +0100
Subject: [PATCH 08/27] vipAccount

---
 sql/own/logon_vipAccount.sql            |    1 +
 src/server/game/Server/WorldSession.cpp |    4 ++--
 src/server/game/Server/WorldSession.h   |    4 +++-
 src/server/game/Server/WorldSocket.cpp  |    6 ++++--
 src/server/game/World/World.cpp         |    2 +-
 5 files changed, 11 insertions(+), 6 deletions(-)
 create mode 100644 sql/own/logon_vipAccount.sql

diff --git a/sql/own/logon_vipAccount.sql b/sql/own/logon_vipAccount.sql
new file mode 100644
index 0000000..a556336
--- /dev/null
+++ b/sql/own/logon_vipAccount.sql
@@ -0,0 +1 @@
+ALTER TABLE `account` ADD `vip` tinyint(3) unsigned NOT NULL DEFAULT '0' AFTER `recruiter`;
diff --git a/src/server/game/Server/WorldSession.cpp b/src/server/game/Server/WorldSession.cpp
index 211ca42..ee1ef00 100755
--- a/src/server/game/Server/WorldSession.cpp
+++ b/src/server/game/Server/WorldSession.cpp
@@ -88,9 +88,9 @@ bool WorldSessionFilter::Process(WorldPacket* packet)
 }
 
 /// WorldSession constructor
-WorldSession::WorldSession(uint32 id, WorldSocket* sock, AccountTypes sec, uint8 expansion, time_t mute_time, LocaleConstant locale, uint32 recruiter, bool isARecruiter):
+WorldSession::WorldSession(uint32 id, WorldSocket* sock, AccountTypes sec, uint8 expansion, bool vip, time_t mute_time, LocaleConstant locale, uint32 recruiter, bool isARecruiter):
 m_muteTime(mute_time), m_timeOutTime(0), _player(NULL), m_Socket(sock),
-_security(sec), _accountId(id), m_expansion(expansion), _logoutTime(0),
+_security(sec), _accountId(id), m_expansion(expansion), vip(vip), _logoutTime(0),
 m_inQueue(false), m_playerLoading(false), m_playerLogout(false),
 m_playerRecentlyLogout(false), m_playerSave(false),
 m_sessionDbcLocale(sWorld->GetAvailableDbcLocale(locale)),
diff --git a/src/server/game/Server/WorldSession.h b/src/server/game/Server/WorldSession.h
index e5bd8b4..1f1f3eb 100755
--- a/src/server/game/Server/WorldSession.h
+++ b/src/server/game/Server/WorldSession.h
@@ -213,7 +213,7 @@ class CharacterCreateInfo
 class WorldSession
 {
     public:
-        WorldSession(uint32 id, WorldSocket* sock, AccountTypes sec, uint8 expansion, time_t mute_time, LocaleConstant locale, uint32 recruiter, bool isARecruiter);
+        WorldSession(uint32 id, WorldSocket* sock, AccountTypes sec, uint8 expansion, bool vip, time_t mute_time, LocaleConstant locale, uint32 recruiter, bool isARecruiter);
         ~WorldSession();
 
         bool PlayerLoading() const { return m_playerLoading; }
@@ -242,6 +242,7 @@ class WorldSession
 
         AccountTypes GetSecurity() const { return _security; }
         uint32 GetAccountId() const { return _accountId; }
+        bool IsVIP() const { return vip; }
         Player* GetPlayer() const { return _player; }
         char const* GetPlayerName() const;
         uint32 GetGuidLow() const;
@@ -960,6 +961,7 @@ class WorldSession
         AddonsList m_addonsList;
         uint32 recruiterId;
         bool isRecruiter;
+        bool vip;
         ACE_Based::LockedQueue<WorldPacket*, ACE_Thread_Mutex> _recvQueue;
         time_t timeLastWhoCommand;
 };
diff --git a/src/server/game/Server/WorldSocket.cpp b/src/server/game/Server/WorldSocket.cpp
index 2c6098f..33afbbb 100755
--- a/src/server/game/Server/WorldSocket.cpp
+++ b/src/server/game/Server/WorldSocket.cpp
@@ -817,7 +817,7 @@ int WorldSocket::HandleAuthSession (WorldPacket& recvPacket)
     // No SQL injection, username escaped.
 
     //                                                 0       1          2       3     4  5      6          7       8         9      10
-    QueryResult result = LoginDatabase.PQuery ("SELECT id, sessionkey, last_ip, locked, v, s, expansion, mutetime, locale, recruiter, os FROM account "
+    QueryResult result = LoginDatabase.PQuery ("SELECT id, sessionkey, last_ip, locked, v, s, expansion, mutetime, locale, recruiter, vip, os FROM account "
                                                "WHERE username = '%s'", safe_account.c_str());
 
     // Stop if the account is not found
@@ -898,6 +898,8 @@ int WorldSocket::HandleAuthSession (WorldPacket& recvPacket)
     uint32 recruiter = fields[9].GetUInt32();
     std::string os = fields[10].GetString();
 
+    bool vip = fields[10].GetBool();
+
     // Checks gmlevel per Realm
     result =
         LoginDatabase.PQuery ("SELECT "
@@ -992,7 +994,7 @@ int WorldSocket::HandleAuthSession (WorldPacket& recvPacket)
     LoginDatabase.Execute(stmt);
 
     // NOTE ATM the socket is single-threaded, have this in mind ...
-    ACE_NEW_RETURN (m_Session, WorldSession (id, this, AccountTypes(security), expansion, mutetime, locale, recruiter, isRecruiter), -1);
+    ACE_NEW_RETURN (m_Session, WorldSession (id, this, AccountTypes(security), expansion, vip, mutetime, locale, recruiter, isRecruiter), -1);
 
     m_Crypt.Init(&k);
 
diff --git a/src/server/game/World/World.cpp b/src/server/game/World/World.cpp
index c59a7ab..27c7fc7 100755
--- a/src/server/game/World/World.cpp
+++ b/src/server/game/World/World.cpp
@@ -262,7 +262,7 @@ World::AddSession_(WorldSession* s)
     if (decrease_session)
         --Sessions;
 
-    if (pLimit > 0 && Sessions >= pLimit && AccountMgr::IsPlayerAccount(s->GetSecurity()) && !HasRecentlyDisconnected(s))
+    if (pLimit > 0 && Sessions >= pLimit && AccountMgr::IsPlayerAccount(s->GetSecurity()) && !HasRecentlyDisconnected(s) && !s->IsVIP())
     {
         AddQueuedPlayer (s);
         UpdateMaxSessionCounters();
-- 
1.7.5.4

