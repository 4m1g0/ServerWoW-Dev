From c1f6bf706717ed483d653da3157d40acf5a495c7 Mon Sep 17 00:00:00 2001
From: 4m1g0 <casadelblanco@gmail.com>
Date: Fri, 29 Jun 2012 18:40:26 +0200
Subject: [PATCH 28/29] SindragosaIceTomb

---
 sql/own/0029-world_script_names.sql                |   12 ++++
 .../Northrend/IcecrownCitadel/boss_sindragosa.cpp  |   58 ++++++++++++++++++++
 2 files changed, 70 insertions(+)
 create mode 100644 sql/own/0029-world_script_names.sql

diff --git a/sql/own/0029-world_script_names.sql b/sql/own/0029-world_script_names.sql
new file mode 100644
index 0000000..921701b
--- /dev/null
+++ b/sql/own/0029-world_script_names.sql
@@ -0,0 +1,12 @@
+DELETE FROM `spell_script_names` WHERE `ScriptName`='spell_sindragosa_collision_filter';
+INSERT INTO `spell_script_names` (`spell_id`, `ScriptName`) VALUES 
+(69845, 'spell_sindragosa_collision_filter'),
+(70117, 'spell_sindragosa_collision_filter'),
+(70127, 'spell_sindragosa_collision_filter'),
+(71053, 'spell_sindragosa_collision_filter'),
+(71054, 'spell_sindragosa_collision_filter'),
+(71055, 'spell_sindragosa_collision_filter'),
+(72528, 'spell_sindragosa_collision_filter'),
+(72529, 'spell_sindragosa_collision_filter'),
+(72530, 'spell_sindragosa_collision_filter');
+
diff --git a/src/server/scripts/Northrend/IcecrownCitadel/boss_sindragosa.cpp b/src/server/scripts/Northrend/IcecrownCitadel/boss_sindragosa.cpp
index fdc9a6a..149158c 100644
--- a/src/server/scripts/Northrend/IcecrownCitadel/boss_sindragosa.cpp
+++ b/src/server/scripts/Northrend/IcecrownCitadel/boss_sindragosa.cpp
@@ -1257,6 +1257,63 @@ class spell_sindragosa_ice_tomb : public SpellScriptLoader
         }
 };
 
+class FrostBombTargetSelector
+{
+    public:
+        FrostBombTargetSelector(Unit* caster, std::list<Creature*> const& collisionList) : _caster(caster), _collisionList(collisionList) { }
+
+        bool operator()(Unit* unit)
+        {
+            if (unit->HasAura(SPELL_ICE_TOMB_DAMAGE))
+                return true;
+
+            for (std::list<Creature*>::const_iterator itr = _collisionList.begin(); itr != _collisionList.end(); ++itr)
+                if ((*itr)->IsInBetween(_caster, unit))
+                    return true;
+
+            return false;
+        }
+
+    private:
+        Unit* _caster;
+        std::list<Creature*> const& _collisionList;
+};
+
+class spell_sindragosa_collision_filter : public SpellScriptLoader
+{
+    public:
+        spell_sindragosa_collision_filter() : SpellScriptLoader("spell_sindragosa_collision_filter") { }
+
+        class spell_sindragosa_collision_filter_SpellScript : public SpellScript
+        {
+            PrepareSpellScript(spell_sindragosa_collision_filter_SpellScript);
+
+            bool Validate(SpellInfo const* /*spell*/)
+            {
+                if (!sSpellMgr->GetSpellInfo(SPELL_ICE_TOMB_DAMAGE))
+                    return false;
+                return true;
+            }
+
+            void FilterTargets(std::list<Unit*>& unitList)
+            {
+                std::list<Creature*> tombs;
+                GetCreatureListWithEntryInGrid(tombs, GetCaster(), NPC_ICE_TOMB, 200.0f);
+                unitList.remove_if (FrostBombTargetSelector(GetCaster(), tombs));
+            }
+
+            void Register()
+            {
+                OnObjectAreaTargetSelect += SpellUnitTargetFn(spell_sindragosa_collision_filter_SpellScript::FilterTargets, EFFECT_0, TARGET_UNIT_SRC_AREA_ENEMY);
+            }
+        };
+
+        SpellScript* GetSpellScript() const
+        {
+            return new spell_sindragosa_collision_filter_SpellScript();
+        }
+};
+
 class spell_sindragosa_icy_grip : public SpellScriptLoader
 {
     public:
@@ -1555,6 +1612,7 @@ void AddSC_boss_sindragosa()
     new spell_sindragosa_instability();
     new spell_sindragosa_frost_beacon();
     new spell_sindragosa_ice_tomb();
+    new spell_sindragosa_collision_filter();
     new spell_sindragosa_icy_grip();
     new spell_sindragosa_mystic_buffet();
     new spell_rimefang_icy_blast();
-- 
1.7.9.5

