From 3ed57a1a4f2006ae878a713380a44df15d6dad4c Mon Sep 17 00:00:00 2001
From: 4m1g0 <casadelblanco@gmail.com>
Date: Tue, 3 Apr 2012 05:45:18 +0200
Subject: [PATCH] fix The Affray

---
 src/server/scripts/Kalimdor/the_barrens.cpp |   40 ++++++---------------------
 1 files changed, 9 insertions(+), 31 deletions(-)

diff --git a/src/server/scripts/Kalimdor/the_barrens.cpp b/src/server/scripts/Kalimdor/the_barrens.cpp
index c56991e..8e9ad6f 100644
--- a/src/server/scripts/Kalimdor/the_barrens.cpp
+++ b/src/server/scripts/Kalimdor/the_barrens.cpp
@@ -408,42 +408,26 @@ public:
                     return;
 
                 if (!pWarrior->isAlive() && pWarrior->GetQuestStatus(1719) == QUEST_STATUS_INCOMPLETE) {
-                    EventInProgress = false;
                     DoScriptText(SAY_TWIGGY_FLATHEAD_DOWN, me);
                     pWarrior->FailQuest(1719);
 
-                    for (uint8 i = 0; i < 6; ++i)
+                    for (uint8 i = 0; i < 6; ++i) // unsummon challengers
                     {
                         if (AffrayChallenger[i])
                         {
                             Creature* creature = Unit::GetCreature((*me), AffrayChallenger[i]);
-                            if (creature) {
-                                if (creature->isAlive())
-                                {
-                                    creature->RemoveFlag(UNIT_FIELD_FLAGS, UNIT_FLAG_IN_COMBAT);
-                                    creature->SetFlag(UNIT_FIELD_FLAGS, UNIT_FLAG_NOT_SELECTABLE);
-                                    creature->setDeathState(JUST_DIED);
-                                }
-                            }
+                            if (creature && creature->isAlive())
+                                creature->DisappearAndDie();
                         }
-                        AffrayChallenger[i] = 0;
-                        Challenger_down[i] = false;
                     }
 
-                    if (BigWill)
+                    if (BigWill) // unsummon bigWill
                     {
                         Creature* creature = Unit::GetCreature((*me), BigWill);
-                        if (creature)
-                        {
-                            if (creature->isAlive())
-                            {
-                                creature->RemoveFlag(UNIT_FIELD_FLAGS, UNIT_FLAG_IN_COMBAT);
-                                creature->SetFlag(UNIT_FIELD_FLAGS, UNIT_FLAG_NOT_SELECTABLE);
-                                creature->setDeathState(JUST_DIED);
-                            }
-                        }
+                        if (creature && creature->isAlive())
+                            creature->DisappearAndDie();
                     }
-                    BigWill = 0;
+                    Reset();
                 }
 
                 if (!EventGrate && EventInProgress)
@@ -453,7 +437,7 @@ public:
 
                     if (x >= -1684 && x <= -1674 && y >= -4334 && y <= -4324) {
                         pWarrior->AreaExploredOrEventHappens(1719);
-                        DoScriptText(SAY_TWIGGY_FLATHEAD_BEGIN, me);
+                        DoScriptText(SAY_TWIGGY_FLATHEAD_BEGIN, me, pWarrior);
 
                         for (uint8 i = 0; i < 6; ++i)
                         {
@@ -511,8 +495,6 @@ public:
                             if (Creature* creature = me->SummonCreature(NPC_BIG_WILL, -1722, -4341, 6.12f, 6.26f, TEMPSUMMON_TIMED_OR_DEAD_DESPAWN, 480000))
                             {
                                 BigWill = creature->GetGUID();
-                                //creature->GetMotionMaster()->MovePoint(0, -1693, -4343, 4.32f);
-                                //creature->GetMotionMaster()->MovePoint(1, -1684, -4333, 2.78f);
                                 creature->GetMotionMaster()->MovePoint(2, -1682, -4329, 2.79f);
                                 creature->HandleEmoteCommand(EMOTE_STATE_READY_UNARMED);
                                 EventBigWill = true;
@@ -525,11 +507,7 @@ public:
                             if (!creature || !creature->isAlive())
                             {
                                 DoScriptText(SAY_TWIGGY_FLATHEAD_OVER, me);
-                                EventInProgress = false;
-                                EventBigWill = false;
-                                EventGrate = false;
-                                PlayerGUID = 0;
-                                Wave = 0;
+                                Reset();
                             }
                         }
                     } else Wave_Timer -= diff;
-- 
1.7.5.4

