From bd46bdf97f7b726a13b660e7df4d22b1f7bc1f80 Mon Sep 17 00:00:00 2001
From: tuamigo <tuamigo@tuamigo-System-Product-Name.(none)>
Date: Tue, 20 Sep 2011 05:31:29 +0200
Subject: [PATCH] uptime

---
 sql/own/0004-Uptime.sql         |    3 +++
 src/server/game/World/World.cpp |    5 +++--
 2 files changed, 6 insertions(+), 2 deletions(-)
 create mode 100644 sql/own/0004-Uptime.sql

diff --git a/sql/own/0004-Uptime.sql b/sql/own/0004-Uptime.sql
new file mode 100644
index 0000000..91b0157
--- /dev/null
+++ b/sql/own/0004-Uptime.sql
@@ -0,0 +1,3 @@
+ALTER TABLE `realmdb`.`uptime` DROP column `maxplayers`,
+  ADD column `players` smallint(5) UNSIGNED DEFAULT '0' NOT NULL after `uptime`,
+  ADD column `queued` smallint(5) UNSIGNED DEFAULT '0' NOT NULL after `players`;
diff --git a/src/server/game/World/World.cpp b/src/server/game/World/World.cpp
index 7631000..d3eb763 100755
--- a/src/server/game/World/World.cpp
+++ b/src/server/game/World/World.cpp
@@ -1934,10 +1934,11 @@ void World::Update(uint32 diff)
     if (m_timers[WUPDATE_UPTIME].Passed())
     {
         uint32 tmpDiff = uint32(m_gameTime - m_startTime);
-        uint32 maxOnlinePlayers = GetMaxPlayerCount();
+        uint32 OnlinePlayers = GetActiveSessionCount();
+        uint32 activeQueued = GetQueuedSessionCount();
 
         m_timers[WUPDATE_UPTIME].Reset();
-        LoginDatabase.PExecute("UPDATE uptime SET uptime = %u, maxplayers = %u WHERE realmid = %u AND starttime = " UI64FMTD, tmpDiff, maxOnlinePlayers, realmID, uint64(m_startTime));
+        LoginDatabase.PExecute("UPDATE uptime SET uptime = %u, players = %u, queued = %u WHERE realmid = %u AND starttime = " UI64FMTD, tmpDiff, OnlinePlayers, activeQueued, realmID, uint64(m_startTime));
     }
 
     /// <li> Clean logs table
-- 
1.7.4.1

